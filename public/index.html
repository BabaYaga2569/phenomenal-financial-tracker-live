<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Phenomenal Financial Tracker - AI-Powered Intelligence with LIVE Banking</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<!-- Plaid Link SDK - PRODUCTION -->
<script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>

<style>
/* === your styles unchanged === */
:root{
  --bg:#0f1116;--card:#14161b;--muted:#9aa3b2;--text:#e7ecf3;--accent:#7c5cff;--accent2:#00d7c0;--good:#17c964;--warn:#ffb703;--bad:#ff5470;--plaid:#00d4ff;--ai:#ff6b9d;--neural:#4ecdc4;
  --glass-bg:rgba(20, 22, 27, 0.8);
  --glass-border:rgba(255, 255, 255, 0.1);
  --hover-lift:translateY(-4px);
  --shadow-soft:0 8px 32px rgba(0, 0, 0, 0.12);
  --shadow-strong:0 20px 40px rgba(0, 0, 0, 0.4);
  --ai-glow:0 0 20px rgba(255, 107, 157, 0.3);
  --neural-glow:0 0 15px rgba(78, 205, 196, 0.4);
}
*{box-sizing:border-box}
body{
  margin:0;font-family:Inter,system-ui;
  background:linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
  color:var(--text);min-height:100vh;position:relative;overflow-x:hidden;
}
/* ... (ALL your CSS exactly as you pasted) ... */
/* I‚Äôm keeping it intact to avoid truncating this message. */
</style>
</head>
<body>

<div class="container">
  <!-- Enhanced Header with AI Status -->
  <header class="slide-in">
    <div style="display:flex;gap:16px;align-items:center">
      <div class="logo"></div>
      <div>
        <h1>Phenomenal Financial Tracker</h1>
        <div class="sub">
          <span class="status-badge" id="systemStatus">
            <div class="status-dot"></div>
            <span id="statusText">System Ready</span>
          </span>
          <span>‚Ä¢ AI-Powered ‚Ä¢ Plaid Ready ‚Ä¢ LIVE Banking</span>
        </div>
      </div>
    </div>
    <div class="header-actions">
      <div class="connection-status">
        <div class="status-dot"></div>
        <span id="connectionCount">0 Banks Connected</span>
      </div>
      <button class="btn ai-btn" onclick="toggleAIAssistant()">
        üß† AI Assistant
      </button>
      <button class="btn plaid-btn" onclick="connectNewBank()">
        üîó Connect Bank
      </button>
      <button class="btn neural-btn" onclick="showExportModal()">
        üìä Export Data
      </button>
      <div class="user-info">
        <div class="user-avatar" id="userAvatar">U</div>
        <span id="userName">User</span>
      </div>
    </div>
  </header>

  <!-- === your dashboard content unchanged === -->
  <!-- (omitted here for brevity ‚Äì this is identical to what you pasted) -->

</div>

<!-- Enhanced Plaid Connection Modal -->
<div class="plaid-modal" id="plaidModal">
  <div class="plaid-dialog">
    <h3 id="modalTitle">üîó Connect Your Bank Account</h3>
    <div id="modalContent">
      <div style="margin:20px 0">
        <div style="font-size:48px;margin-bottom:16px">üè¶</div>
        <div style="font-size:16px;margin-bottom:16px;color:var(--muted)">
          Connect your real bank account using Plaid
        </div>
        <div style="font-size:12px;color:var(--muted);line-height:1.6">
          üîí Bank-level security ‚Ä¢ üöÄ Instant connection ‚Ä¢ ‚ö° Real-time updates<br>
          <span style="color:var(--warn)">‚ö†Ô∏è Requires backend server for token generation</span>
        </div>
      </div>
      
      <div id="progressSection" style="display:none;margin:20px 0">
        <div style="margin-bottom:12px;font-weight:600;color:var(--plaid)" id="progressText">Connecting...</div>
        <div class="progress-container">
          <div class="progress-fill" id="progressFill" style="width:0%"></div>
        </div>
        <div style="font-size:12px;color:var(--muted);margin-top:8px">
          This may take a few moments while we securely authenticate your account
        </div>
      </div>
      
      <div style="display:flex;gap:12px;justify-content:center;margin-top:24px" id="buttonSection">
        <!-- keep original onclick but we define the alias in JS -->
        <button class="btn plaid-btn" onclick="initializePlaidLink()" id="connectBtn">üöÄ Connect My Bank</button>
        <button class="btn" onclick="closePlaidModal()">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Export Data Modal, AI Assistant, Notifications, Details Modal -->
<!-- (unchanged markup as in your file) -->

<!-- ======================= CLEAN APP SCRIPT ======================= -->
<script>
/* =========================================================================
   Phenomenal Financial Tracker ‚Äî Clean Plaid + UI wiring (single script)
   Back-end endpoints expected:
     POST /api/create_link_token
     POST /api/exchange_public_token
     POST /api/accounts
     POST /api/transactions
     GET  /health
   ======================================================================= */

const API_BASE = window.location.origin;
const USER_ID  = 'user_001';

const AppState = {
  user: { id: USER_ID, name: 'User' },
  plaidLinkToken: null,
  backendStatus: 'unknown',
  isConnecting: false,
  accounts: new Map(),                // Map<account_id, account>
  transactions: [],                   // Array<Plaid txn>
  totals: { connectedBanks: 0, monthlySpending: 0, netWorth: 0, totalTransactions: 0 }
};

// ---- Boot
document.addEventListener('DOMContentLoaded', () => {
  try {
    document.getElementById('userName').textContent = AppState.user.name;
    document.getElementById('userAvatar').textContent = AppState.user.name[0].toUpperCase();
  } catch {}
  tryLoadLiveData();
  showNotification('üöÄ Phenomenal Tracker ready! Connect your first bank to get started.', 'success');
});

// ---- Backend presence + initial data
async function tryLoadLiveData() {
  try {
    const r = await fetch(`${API_BASE}/health`, { cache: 'no-store' });
    if (!r.ok) throw new Error();
    AppState.backendStatus = 'available';
    await tryLoadTransactions();
    updateDashboard();
    showNotification('‚úÖ Connected to live backend!', 'success');
  } catch {
    AppState.backendStatus = 'unavailable';
    updateDashboard();
    showNotification('‚ÑπÔ∏è Backend not reachable yet. You can still open Link once it is.', 'info');
  }
}

// ---- Open Plaid Link
async function connectNewBank() {
  if (AppState.isConnecting) return;
  AppState.isConnecting = true;
  showPlaidModal();

  try {
    // fetch link token
    let resp = await fetch(`${API_BASE}/api/create_link_token`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: AppState.user.id })
    });
    if (!resp.ok) throw new Error(`create_link_token ${resp.status}`);
    const data = await resp.json();
    const link_token = data.link_token || data.linkToken;
    if (!link_token) throw new Error('No link_token returned');
    AppState.plaidLinkToken = link_token;

    // open Link
    const handler = Plaid.create({
      token: link_token,
      onSuccess: handlePlaidSuccess,
      onExit: (err) => {
        if (err) showNotification('‚ùå Bank connection cancelled', 'error');
        closePlaidModal();
        AppState.isConnecting = false;
      }
    });

    handler.open();
  } catch (e) {
    console.error(e);
    showNotification('‚ö†Ô∏è Could not create Plaid Link token (check backend routes).', 'warning');
    closePlaidModal();
    AppState.isConnecting = false;
  }
}

// keep your modal button working
function initializePlaidLink(){ return connectNewBank(); }

// ---- On successful Link
async function handlePlaidSuccess(public_token, metadata) {
  try {
    // 1) Exchange token
    const ex = await fetch(`${API_BASE}/api/exchange_public_token`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ public_token, user_id: AppState.user.id }),
    });
    const exJson = await ex.json().catch(()=> ({}));
    if (!ex.ok || !exJson?.success) {
      console.error('Exchange failed:', ex.status, exJson);
      showNotification('Token exchange failed. Check server logs.', 'error');
      return;
    }

    // 2) Accounts
    const accRes = await fetch(`${API_BASE}/api/accounts`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: AppState.user.id }),
    });
    if (!accRes.ok) {
      const txt = await accRes.text();
      console.error('Accounts error:', txt);
      showNotification('Could not load accounts.', 'warning');
      return;
    }
    const accData = await accRes.json();
    const accounts = accData.accounts || [];
    AppState.accounts = new Map(accounts.map(a => [a.account_id, a]));
    AppState.totals.connectedBanks = accounts.length;
    updateBanksPill(accounts.length);

    // 3) Transactions
    const txRes = await fetch(`${API_BASE}/api/transactions`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: AppState.user.id, start_date: '2024-01-01' }),
    });

    if (txRes.status === 202) {
      console.log('Transactions are syncing; try again shortly.');
    } else if (txRes.ok) {
      const txJson = await txRes.json();
      AppState.transactions = txJson.transactions || [];
      AppState.totals.totalTransactions = AppState.transactions.length;
    } else {
      const txt = await txRes.text();
      console.warn('Transactions fetch failed:', txt);
    }

    // Update UI + close
    updateAccountsDisplay();
    updateTransactionsDisplay();
    updateDashboard();
    closePlaidModal();
    showNotification(`${metadata?.institution?.name || 'Bank'} connected!`, 'success');
  } catch (err) {
    console.error('handlePlaidSuccess failed:', err);
    showNotification('Something went wrong after linking. See console.', 'error');
  } finally {
    AppState.isConnecting = false;
  }
}

// ---- Load any existing transactions on first boot
async function tryLoadTransactions() {
  try {
    const r = await fetch(`${API_BASE}/api/transactions`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: AppState.user.id })
    });
    if (!r.ok) throw new Error();
    const data = await r.json();
    AppState.transactions = Array.isArray(data.transactions) ? data.transactions : [];
    AppState.totals.totalTransactions = AppState.transactions.length;

    // derive accounts if none (from txn account_ids)
    if (!AppState.accounts.size) {
      const ids = [...new Set(AppState.transactions.map(t => t.account_id).filter(Boolean))];
      AppState.accounts = new Map(ids.map(id => [id, {
        account_id: id, name: 'Linked Account', mask: id.slice(-4), balances: { current: 0 }
      }]));
      AppState.totals.connectedBanks = AppState.accounts.size;
    }

    updateAccountsDisplay();
    updateTransactionsDisplay();
  } catch {
    // no data yet ‚Äî fine
  }
}

// ---- UI helpers
function updateDashboard() {
  // Total (unknown without balances, keep 0 for now)
  document.getElementById('totalBalance')?.textContent = formatCurrency(AppState.totals.netWorth || 0);

  // Monthly spending if we have txns
  const txs = AppState.transactions || [];
  if (txs.length) {
    const now = new Date();
    const start = new Date(now.getFullYear(), now.getMonth(), 1);
    const monthly = txs.filter(t => new Date(t.date) >= start && t.amount < 0)
                       .reduce((s, t) => s + Math.abs(t.amount), 0);
    AppState.totals.monthlySpending = monthly;
    const ms = document.getElementById('monthlySpending');
    const st = document.getElementById('spendingStatus');
    if (ms) ms.textContent = formatCurrency(monthly);
    if (st) { st.textContent = 'Real data analysis'; st.className = 'pill good'; }
  } else {
    const ms = document.getElementById('monthlySpending');
    const st = document.getElementById('spendingStatus');
    if (ms) ms.textContent = '$0.00';
    if (st) { st.textContent = 'Connect for insights'; st.className = 'pill ai-status'; }
  }

  // Banks connected + badges
  const n = AppState.totals.connectedBanks || 0;
  updateBanksPill(n);
  const syncText = document.getElementById('syncStatusText');
  if (syncText) syncText.textContent = n ? 'Live Sync Active' : 'Ready to Connect';
  const sText = document.getElementById('statusText');
  if (sText) sText.textContent = n ? 'AI System Active' : 'Ready to Connect';

  // Transactions counter tile
  const ct = document.getElementById('transactionCount');
  if (ct) ct.textContent = String(AppState.totals.totalTransactions || 0);
}

function updateBanksPill(n) {
  ['connectionCount','connectedCount','banksConnectedCount'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.textContent = `${n} ${n===1?'Bank':'Banks'} Connected`;
  });
}

function updateAccountsDisplay() {
  const grid = document.getElementById('accountGrid');
  if (!grid) return;

  if (!AppState.accounts.size) {
    grid.innerHTML = `
      <div style="text-align:center;padding:40px;color:var(--muted)">
        <div style="font-size:48px;margin-bottom:16px">üè¶</div>
        <div style="margin-bottom:16px">Ready to connect your first bank account</div>
        <button class="btn plaid-btn" onclick="connectNewBank()">üöÄ Connect Your First Bank</button>
        <div style="font-size:12px;margin-top:12px;color:var(--muted)">
          üîí Bank-level security via Plaid ‚Ä¢ Real-time updates ‚Ä¢ AI insights
        </div>
      </div>`;
    return;
  }

  const cards = [...AppState.accounts.values()].map(a => `
    <div class="account-card chase">
      <div class="account-header">
        <div style="display:flex;align-items:center;gap:12px">
          <div class="bank-logo chase">Bank</div>
          <div>
            <div style="font-weight:700">${a.name || 'Linked Account'}</div>
            <div style="font-size:12px;color:var(--muted)">Account ‚Ä¢‚Ä¢‚Ä¢‚Ä¢${a.mask || '----'}</div>
          </div>
        </div>
        <div class="pill plaid-status">Live Connected</div>
      </div>
      <div class="account-balance">‚Äî</div>
      <div class="account-meta">
        <span>Live sync ‚Ä¢ Real-time updates</span>
        <span class="sync-indicator"><div class="status-dot"></div>Live</span>
      </div>
    </div>`).join('');

  grid.innerHTML = cards;
}

function updateTransactionsDisplay() {
  const container = document.getElementById('transactionStream');
  if (!container) return;

  const txs = AppState.transactions || [];
  if (!txs.length) {
    container.innerHTML = `
      <div style="text-align:center;padding:40px;color:var(--muted)">
        <div style="font-size:48px;margin-bottom:16px">‚ö°</div>
        <div>Connect accounts to see real-time transactions</div>
        <div style="font-size:12px;margin-top:8px">Live transaction feed with AI categorization and insights</div>
      </div>`;
    return;
  }

  const recent = txs.slice().sort((a,b)=> new Date(b.date)-new Date(a.date)).slice(0,10);
  container.innerHTML = recent.map(tx => {
    const category = (tx.category && tx.category[0]) || 'Other';
    const amount   = formatCurrency(Math.abs(tx.amount));
    const sign     = tx.amount > 0 ? '+' : '-';
    const cls      = tx.amount > 0 ? 'positive' : 'negative';
    return `
      <div class="transaction-item">
        <div class="merchant-info">
          <div class="merchant-icon">üí≥</div>
          <div>
            <div style="font-weight:700">${tx.name}</div>
            <div style="font-size:12px;color:var(--muted)">${new Date(tx.date).toLocaleDateString()} ‚Ä¢ ${category}</div>
          </div>
        </div>
        <div class="transaction-amount ${cls}">${sign}${amount}</div>
      </div>`;
  }).join('');
}

// ---- Modal helpers
function showPlaidModal(){ document.getElementById('plaidModal')?.classList.add('show'); }
function closePlaidModal(){ document.getElementById('plaidModal')?.classList.remove('show'); }

// ---- Misc helpers (placeholders you already use in UI)
function toggleAIAssistant(){ document.getElementById('aiAssistant')?.classList.toggle('show'); }
function showExportModal(){ document.getElementById('exportModal')?.classList.add('show'); }
function closeExportModal(){ document.getElementById('exportModal')?.classList.remove('show'); }
function closeDetailsModal(){ document.getElementById('detailsModal')?.classList.remove('show'); }
function showNotification(message, type='info', duration=4000){
  const el = document.getElementById('notification');
  if (!el) return;
  const icons = { success:'‚úÖ', error:'‚ùå', info:'‚ÑπÔ∏è', warning:'‚ö†Ô∏è', ai:'üß†' };
  el.className = `notification ${type}`;
  el.innerHTML = `<div style="display:flex;align-items:center;gap:12px">
      <div style="font-size:20px">${icons[type]||'‚ÑπÔ∏è'}</div>
      <div><div style="font-weight:700">${message}</div>
      <div style="font-size:12px;color:var(--muted)">${new Date().toLocaleTimeString()}</div></div></div>`;
  el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), duration);
}
function formatCurrency(x){ return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(x||0); }

// Expose small console API
window.PhenomenalAI = {
  connectBank: connectNewBank,
  refreshData: tryLoadLiveData,
  info: () => ({ backend: API_BASE, backendStatus: AppState.backendStatus, banks: AppState.totals.connectedBanks, txns: AppState.totals.totalTransactions })
};
console.log('‚úÖ Plaid wiring ready. Health:', `${API_BASE}/health`);
</script>
<!-- ===================== END CLEAN APP SCRIPT ===================== -->

</body>
</html>
