<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Phenomenal Financial Tracker - AI-Powered Intelligence with LIVE Banking</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<!-- Plaid Link SDK - PRODUCTION -->
<script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>

<style>
:root{
  --bg:#0f1116;--card:#14161b;--muted:#9aa3b2;--text:#e7ecf3;--accent:#7c5cff;--accent2:#00d7c0;--good:#17c964;--warn:#ffb703;--bad:#ff5470;--plaid:#00d4ff;--ai:#ff6b9d;--neural:#4ecdc4;
  --glass-bg:rgba(20, 22, 27, 0.8);
  --glass-border:rgba(255, 255, 255, 0.1);
  --hover-lift:translateY(-4px);
  --shadow-soft:0 8px 32px rgba(0, 0, 0, 0.12);
  --shadow-strong:0 20px 40px rgba(0, 0, 0, 0.4);
  --ai-glow:0 0 20px rgba(255, 107, 157, 0.3);
  --neural-glow:0 0 15px rgba(78, 205, 196, 0.4);
}

*{box-sizing:border-box}

body{
  margin:0;font-family:Inter,system-ui;
  background:linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
  color:var(--text);min-height:100vh;position:relative;overflow-x:hidden;
}

/* Enhanced animated background with AI elements */
body::before{
  content:'';position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;
  background:radial-gradient(circle at 20% 80%, rgba(120,119,198,0.1) 0%, transparent 50%),
             radial-gradient(circle at 80% 20%, rgba(255,107,157,0.08) 0%, transparent 50%),
             radial-gradient(circle at 40% 40%, rgba(78,205,196,0.06) 0%, transparent 50%),
             radial-gradient(circle at 60% 90%, rgba(124,92,255,0.04) 0%, transparent 50%);
  animation: aiBackgroundFlow 40s ease-in-out infinite alternate;
}

@keyframes aiBackgroundFlow {
  0% { transform: translateX(0px) translateY(0px) scale(1) rotate(0deg); }
  100% { transform: translateX(-30px) translateY(-15px) scale(1.05) rotate(1deg); }
}

.container{
  max-width:1400px;margin:0 auto;padding:20px;position:relative;z-index:1;
}

/* Enhanced Header with AI indicator */
header{
  display:flex;gap:12px;justify-content:space-between;align-items:center;
  margin-bottom:32px;padding:20px 0;
  backdrop-filter:blur(20px);background:rgba(15, 17, 22, 0.8);
  border-radius:0 0 24px 24px;
}

.logo{
  width:60px;height:60px;border-radius:20px;
  background:linear-gradient(135deg, #667eea 0%, #764ba2 50%, #ff6b9d 100%);
  display:flex;align-items:center;justify-content:center;
  font-size:28px;position:relative;overflow:hidden;
  box-shadow:var(--ai-glow);
  animation:logoFloat 6s ease-in-out infinite;
}

.logo::before{
  content:'üß†';position:absolute;transition:transform 0.3s ease;
}

.logo:hover::before{
  transform:scale(1.2) rotate(10deg);
}

@keyframes logoFloat {
  0%, 100% { transform: translateY(0px); box-shadow: var(--ai-glow); }
  50% { transform: translateY(-3px); box-shadow: var(--neural-glow); }
}

h1{
  margin:0;font-size:28px;font-weight:800;
  background:linear-gradient(135deg, #667eea 0%, #764ba2 50%, #ff6b9d 100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  background-clip:text;
}

.sub{
  color:var(--muted);font-size:14px;margin-top:4px;
  display:flex;align-items:center;gap:8px;
}

.status-badge{
  display:inline-flex;align-items:center;gap:6px;
  padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700;
  background:rgba(255, 107, 157, 0.1);border:1px solid rgba(255, 107, 157, 0.3);
  color:var(--ai);animation:aiPulse 3s infinite;
}

@keyframes aiPulse {
  0%, 100% { opacity: 1; box-shadow: none; }
  50% { opacity: 0.8; box-shadow: var(--ai-glow); }
}

.header-actions{
  display:flex;gap:12px;align-items:center;flex-wrap:wrap;
}

button,input,select,textarea{
  background:var(--glass-bg);border:1px solid var(--glass-border);
  color:var(--text);padding:12px 16px;border-radius:16px;font-weight:600;
  backdrop-filter:blur(20px);transition:all 0.3s ease;
  font-family:inherit;
}

.btn{
  cursor:pointer;position:relative;overflow:hidden;
}

.btn::before{
  content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;
  background:linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
  transition:left 0.6s ease;
}

.btn:hover{
  transform:var(--hover-lift);box-shadow:var(--shadow-strong);
  border-color:var(--accent);
}

.btn:hover::before{
  left:100%;
}

.btn:active{
  transform:translateY(-1px);
}

.primary{
  background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border:1px solid #667eea;color:#fff;
  box-shadow:0 8px 32px rgba(102, 126, 234, 0.3);
}

.ai-btn{
  background:linear-gradient(135deg, var(--ai) 0%, #e84393 100%);
  border:1px solid var(--ai);color:#fff;
  box-shadow:var(--ai-glow);
}

.plaid-btn{
  background:linear-gradient(135deg, var(--plaid) 0%, #0099cc 100%);
  border:1px solid var(--plaid);color:#fff;
  box-shadow:0 8px 32px rgba(0, 212, 255, 0.3);
}

.neural-btn{
  background:linear-gradient(135deg, var(--neural) 0%, #00b894 100%);
  border:1px solid var(--neural);color:#fff;
  box-shadow:var(--neural-glow);
}

.user-info{
  display:flex;align-items:center;gap:12px;
  padding:8px 16px;background:var(--glass-bg);
  border-radius:20px;backdrop-filter:blur(20px);
}

.user-avatar{
  width:32px;height:32px;border-radius:50%;
  background:linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  display:flex;align-items:center;justify-content:center;
  font-weight:700;color:#fff;
}

/* Enhanced Grid System */
.grid4{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
  gap:20px;margin-bottom:32px;
}

.tile{
  padding:24px;background:var(--glass-bg);backdrop-filter:blur(20px);
  border:1px solid var(--glass-border);border-radius:24px;
  position:relative;overflow:hidden;transition:all 0.4s ease;
  cursor:pointer;
}

.tile::before{
  content:'';position:absolute;top:0;left:0;right:0;height:4px;
  background:linear-gradient(90deg, var(--accent), var(--accent2), var(--ai), var(--neural));
  opacity:0;transition:opacity 0.3s ease;
}

.tile:hover{
  transform:var(--hover-lift);box-shadow:var(--shadow-strong);
  border-color:var(--accent);
}

.tile:hover::before{
  opacity:1;
}

.tile.ai-enhanced{
  border:1px solid rgba(255, 107, 157, 0.3);
}

.tile.ai-enhanced:hover{
  box-shadow:var(--ai-glow);
  border-color:var(--ai);
}

.tile-header{
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom:12px;
}

.tile-icon{
  width:40px;height:40px;border-radius:12px;
  display:flex;align-items:center;justify-content:center;
  font-size:20px;background:var(--glass-bg);
}

.small{
  color:var(--muted);font-size:14px;font-weight:600;
}

.val{
  font-size:32px;font-weight:800;margin:8px 0;
  background:linear-gradient(135deg, var(--text) 0%, var(--accent) 50%, var(--ai) 100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  background-clip:text;
}

.pill{
  padding:6px 12px;border-radius:20px;font-size:12px;font-weight:700;
  display:inline-flex;align-items:center;gap:6px;
  transition:all 0.3s ease;
}

.pill::before{
  content:'';width:6px;height:6px;border-radius:50%;
  animation:pulse 2s infinite;
}

.good{
  background:rgba(23,201,100,.1);color:var(--good);
  border:1px solid rgba(23,201,100,.3);
}

.good::before{background:var(--good)}

.warn{
  background:rgba(255,183,3,.1);color:var(--warn);
  border:1px solid rgba(255,183,3,.3);
}

.warn::before{background:var(--warn)}

.bad{
  background:rgba(255,84,112,.1);color:var(--bad);
  border:1px solid rgba(255,84,112,.3);
}

.bad::before{background:var(--bad)}

.ai-status{
  background:rgba(255,107,157,.1);color:var(--ai);
  border:1px solid rgba(255,107,157,.3);
}

.ai-status::before{background:var(--ai)}

.neural-status{
  background:rgba(78,205,196,.1);color:var(--neural);
  border:1px solid rgba(78,205,196,.3);
}

.neural-status::before{background:var(--neural)}

.plaid-status{
  background:rgba(0,212,255,.1);color:var(--plaid);
  border:1px solid rgba(0,212,255,.3);
}

.plaid-status::before{background:var(--plaid)}

/* Enhanced Cards */
.card{
  background:var(--glass-bg);backdrop-filter:blur(20px);
  border:1px solid var(--glass-border);border-radius:24px;
  padding:24px;transition:all 0.4s ease;position:relative;overflow:hidden;
  margin-bottom:24px;
}

.card::before{
  content:'';position:absolute;top:0;left:0;right:0;height:2px;
  background:linear-gradient(90deg, var(--accent), var(--accent2), var(--ai));
  opacity:0;transition:opacity 0.3s ease;
}

.card:hover{
  transform:var(--hover-lift);box-shadow:var(--shadow-strong);
  border-color:var(--accent);
}

.card:hover::before{
  opacity:1;
}

.card.ai-powered{
  border:1px solid rgba(255, 107, 157, 0.2);
}

.card.ai-powered:hover{
  border-color:var(--ai);
  box-shadow:var(--ai-glow);
}

.card h2,h3{
  margin:0 0 16px 0;font-weight:800;
  display:flex;align-items:center;gap:12px;
}

.card-icon{
  width:32px;height:32px;border-radius:10px;
  background:linear-gradient(135deg, var(--accent), var(--accent2));
  display:flex;align-items:center;justify-content:center;
  font-size:16px;
}

.ai-icon{
  background:linear-gradient(135deg, var(--ai), var(--neural));
  box-shadow:var(--ai-glow);
}

/* Connection Status */
.connection-status{
  display:flex;align-items:center;gap:8px;
  padding:8px 16px;background:var(--glass-bg);
  border-radius:20px;backdrop-filter:blur(20px);
  border:1px solid var(--glass-border);
}

.status-dot{
  width:8px;height:8px;border-radius:50%;
  background:var(--good);animation:pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

/* Account Cards */
.account-grid{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
  gap:20px;margin:20px 0;
}

.account-card{
  padding:20px;background:var(--glass-bg);backdrop-filter:blur(20px);
  border:1px solid var(--glass-border);border-radius:20px;
  transition:all 0.4s ease;position:relative;overflow:hidden;
  cursor:pointer;
}

.account-card::before{
  content:'';position:absolute;top:0;left:0;right:0;height:3px;
  opacity:0;transition:opacity 0.3s ease;
}

.account-card.bofa::before{
  background:linear-gradient(90deg, #e31837, #ff4444);
}

.account-card.chase::before{
  background:linear-gradient(90deg, #0066b2, #0088cc);
}

.account-card.wells::before{
  background:linear-gradient(90deg, #d71e2b, #ff4444);
}

.account-card.citi::before{
  background:linear-gradient(90deg, #004aad, #0066cc);
}

.account-card.usaa::before{
  background:linear-gradient(90deg, #004080, #0066cc);
}

.account-card.capone::before{
  background:linear-gradient(90deg, #004879, #0066aa);
}

.account-card.sofi::before{
  background:linear-gradient(90deg, #00d4aa, #00e6cc);
}

.account-card:hover{
  transform:var(--hover-lift);box-shadow:var(--shadow-strong);
}

.account-card:hover::before{
  opacity:1;
}

.account-card.connecting{
  border-color:var(--plaid);
  animation:connectingPulse 2s infinite;
}

@keyframes connectingPulse {
  0%, 100% { border-color: var(--plaid); opacity: 1; }
  50% { border-color: rgba(0, 212, 255, 0.3); opacity: 0.8; }
}

.account-header{
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom:16px;
}

.bank-logo{
  width:48px;height:48px;border-radius:12px;
  display:flex;align-items:center;justify-content:center;
  font-weight:800;font-size:16px;color:#fff;
}

.bank-logo.bofa{
  background:linear-gradient(135deg, #e31837, #ff4444);
}

.bank-logo.chase{
  background:linear-gradient(135deg, #0066b2, #0088cc);
}

.bank-logo.wells{
  background:linear-gradient(135deg, #d71e2b, #ff4444);
}

.bank-logo.citi{
  background:linear-gradient(135deg, #004aad, #0066cc);
}

.bank-logo.usaa{
  background:linear-gradient(135deg, #004080, #0066cc);
}

.bank-logo.capone{
  background:linear-gradient(135deg, #004879, #0066aa);
}

.bank-logo.sofi{
  background:linear-gradient(135deg, #00d4aa, #00e6cc);
}

.account-balance{
  font-size:28px;font-weight:800;margin:8px 0;
  background:linear-gradient(135deg, var(--text), var(--accent));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  background-clip:text;
}

.account-meta{
  display:flex;justify-content:space-between;align-items:center;
  font-size:12px;color:var(--muted);
}

.sync-indicator{
  display:flex;align-items:center;gap:6px;
}

/* Export Options Styling */
.export-option{
  transition:all 0.3s ease;
}

.export-option:hover{
  transform:translateY(-2px);
  box-shadow:0 8px 25px rgba(0,0,0,0.15);
}

/* Plaid Connection Modal */
.plaid-modal{
  position:fixed;inset:0;background:rgba(0,0,0,0.8);
  display:none;align-items:center;justify-content:center;
  z-index:10000;backdrop-filter:blur(10px);
  animation:fadeIn 0.3s ease;
}

.plaid-modal.show{
  display:flex;
}

.plaid-dialog{
  background:var(--glass-bg);backdrop-filter:blur(20px);
  border:1px solid var(--glass-border);border-radius:24px;
  padding:32px;max-width:500px;width:90%;
  text-align:center;position:relative;
}

.plaid-dialog h3{
  margin:0 0 16px 0;font-size:24px;
  color:var(--plaid);
}

.progress-container{
  height:12px;background:rgba(255,255,255,0.1);
  border-radius:10px;overflow:hidden;margin:20px 0;
}

.progress-fill{
  height:100%;background:linear-gradient(90deg, var(--plaid), var(--accent));
  border-radius:10px;transition:width 0.5s ease;position:relative;
}

.progress-fill::before{
  content:'';position:absolute;top:0;left:0;bottom:0;width:100%;
  background:linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
  animation:shimmer 2s infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

/* AI Assistant Interface */
.ai-assistant{
  position:fixed;bottom:20px;right:20px;z-index:1000;
  width:350px;max-height:500px;background:var(--glass-bg);
  backdrop-filter:blur(20px);border:1px solid var(--ai);
  border-radius:20px;box-shadow:var(--ai-glow);
  transform:translateY(600px);transition:transform 0.4s ease;
}

.ai-assistant.show{
  transform:translateY(0);
}

.ai-header{
  padding:16px 20px;border-bottom:1px solid var(--glass-border);
  display:flex;align-items:center;justify-content:space-between;
}

.ai-avatar{
  width:40px;height:40px;border-radius:50%;
  background:linear-gradient(135deg, var(--ai), var(--neural));
  display:flex;align-items:center;justify-content:center;
  font-size:20px;animation:aiPulse 3s infinite;
}

.ai-chat{
  max-height:300px;overflow-y:auto;padding:16px;
}

.ai-message{
  margin-bottom:12px;padding:12px;border-radius:12px;
  background:rgba(255,107,157,0.1);border:1px solid rgba(255,107,157,0.2);
  animation:slideInUp 0.5s ease;
}

.ai-input{
  padding:16px;border-top:1px solid var(--glass-border);
  display:flex;gap:8px;
}

.ai-input input{
  flex:1;background:rgba(255,255,255,0.05);
  border:1px solid var(--glass-border);border-radius:20px;
  padding:8px 16px;color:var(--text);
}

.ai-input button{
  background:linear-gradient(135deg, var(--ai), var(--neural));
  border:none;border-radius:50%;width:40px;height:40px;
  color:#fff;cursor:pointer;
}

/* AI Predictions & Analytics */
.prediction-card{
  background:linear-gradient(135deg, rgba(255,107,157,0.05), rgba(78,205,196,0.05));
  border:1px solid rgba(255,107,157,0.2);border-radius:16px;
  padding:20px;margin:16px 0;position:relative;
}

.prediction-card::before{
  content:'üîÆ';position:absolute;top:16px;right:16px;
  font-size:24px;opacity:0.6;
}

.confidence-bar{
  height:6px;background:rgba(255,255,255,0.1);
  border-radius:10px;overflow:hidden;margin:8px 0;
}

.confidence-fill{
  height:100%;background:linear-gradient(90deg, var(--ai), var(--neural));
  border-radius:10px;transition:width 1s ease;
}

/* Neural Network Visualization */
.neural-viz{
  position:relative;height:200px;background:rgba(0,0,0,0.2);
  border-radius:16px;overflow:hidden;margin:16px 0;
}

.neural-node{
  position:absolute;width:12px;height:12px;
  background:var(--neural);border-radius:50%;
  animation:neuralPulse 2s infinite;
}

@keyframes neuralPulse {
  0%, 100% { opacity: 0.6; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.2); }
}

.neural-connection{
  position:absolute;height:2px;background:linear-gradient(90deg, var(--ai), var(--neural));
  opacity:0.4;animation:dataFlow 3s infinite;
}

@keyframes dataFlow {
  0% { opacity: 0.2; }
  50% { opacity: 0.8; }
  100% { opacity: 0.2; }
}

/* Smart Insights */
.insight-grid{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:16px;margin:20px 0;
}

.insight-item{
  padding:16px;background:rgba(255,107,157,0.05);
  border:1px solid rgba(255,107,157,0.2);border-radius:12px;
  text-align:center;transition:all 0.3s ease;
  cursor:pointer;
}

.insight-item:hover{
  background:rgba(255,107,157,0.1);
  transform:translateY(-2px);
}

.insight-value{
  font-size:24px;font-weight:800;color:var(--ai);
  margin:8px 0;
}

.insight-label{
  font-size:12px;color:var(--muted);
}

/* Transaction Stream */
.transaction-stream{
  max-height:400px;overflow-y:auto;
  background:var(--glass-bg);border-radius:16px;
  backdrop-filter:blur(20px);border:1px solid var(--glass-border);
}

.transaction-item{
  display:flex;justify-content:space-between;align-items:center;
  padding:16px;border-bottom:1px solid var(--glass-border);
  transition:all 0.3s ease;position:relative;cursor:pointer;
}

.transaction-item:hover{
  background:rgba(124, 92, 255, 0.05);
  transform:translateX(4px);
}

.transaction-item:last-child{
  border-bottom:none;
}

.transaction-item.predicted{
  background:rgba(255,107,157,0.05);
  border-left:3px solid var(--ai);
}

.transaction-item.new{
  animation:slideInRight 0.5s ease;
  background:rgba(0, 212, 255, 0.1);
}

@keyframes slideInRight {
  from { opacity: 0; transform: translateX(30px); }
  to { opacity: 1; transform: translateX(0); }
}

.merchant-info{
  display:flex;align-items:center;gap:12px;
}

.merchant-icon{
  width:40px;height:40px;border-radius:10px;
  background:var(--accent);display:flex;align-items:center;
  justify-content:center;font-size:16px;
}

.transaction-amount{
  font-weight:800;font-size:16px;
}

.transaction-amount.positive{
  color:var(--good);
}

.transaction-amount.negative{
  color:var(--bad);
}

.ai-prediction-tag{
  position:absolute;top:8px;right:8px;
  background:var(--ai);color:#fff;font-size:8px;
  padding:2px 6px;border-radius:8px;font-weight:700;
}

/* Notifications */
.notification{
  position:fixed;top:20px;right:20px;z-index:1000;
  background:var(--glass-bg);backdrop-filter:blur(20px);
  border:1px solid var(--glass-border);border-radius:16px;
  padding:16px 20px;max-width:350px;
  transform:translateX(400px);transition:transform 0.4s ease;
  box-shadow:var(--shadow-strong);
}

.notification.show{
  transform:translateX(0);
}

.notification.success{
  border-color:var(--good);
  background:rgba(23, 201, 100, 0.1);
}

.notification.error{
  border-color:var(--bad);
  background:rgba(255, 84, 112, 0.1);
}

.notification.info{
  border-color:var(--plaid);
  background:rgba(0, 212, 255, 0.1);
}

.notification.ai{
  border-color:var(--ai);
  background:rgba(255, 107, 157, 0.1);
  box-shadow:var(--ai-glow);
}

/* Loading States */
.loading {
  position: relative;
  pointer-events: none;
}

.loading::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 20px;
  height: 20px;
  margin: -10px 0 0 -10px;
  border: 2px solid rgba(255,255,255,0.3);
  border-top: 2px solid var(--ai);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Enhanced Features */
.feature-grid{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
  gap:16px;margin:20px 0;
}

.feature-card{
  padding:16px;background:rgba(255,255,255,0.05);
  border:1px solid var(--glass-border);border-radius:12px;
  transition:all 0.3s ease;
}

.feature-card:hover{
  background:rgba(255,255,255,0.08);
  transform:translateY(-2px);
}

.webhook-indicator{
  display:inline-flex;align-items:center;gap:6px;
  padding:4px 8px;border-radius:12px;font-size:10px;font-weight:700;
  background:rgba(0,212,255,0.1);color:var(--plaid);
  border:1px solid rgba(0,212,255,0.3);
}

.realtime-badge{
  background:rgba(23,201,100,0.1);color:var(--good);
  border:1px solid rgba(23,201,100,0.3);
  padding:2px 8px;border-radius:10px;font-size:10px;font-weight:700;
  display:inline-flex;align-items:center;gap:4px;
}

.realtime-badge::before{
  content:'';width:6px;height:6px;border-radius:50%;
  background:var(--good);animation:pulse 1s infinite;
}

/* Responsive */
@media (max-width: 768px) {
  .container{
    padding:16px;
  }
  
  header{
    flex-direction:column;gap:16px;
    padding:16px;
  }
  
  .header-actions{
    justify-content:center;
  }
  
  .grid4{
    grid-template-columns:1fr;
  }
  
  .val{
    font-size:24px;
  }
  
  h1{
    font-size:24px;
    text-align:center;
  }
  
  .ai-assistant{
    width:90%;right:5%;
  }
}

/* Animations */
.slide-in{
  animation:slideInUp 0.6s ease-out;
}

@keyframes slideInUp {
  from { opacity: 0; transform: translateY(30px); }
  to { opacity: 1; transform: translateY(0); }
}

.fade-in{
  animation:fadeIn 0.8s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.scale-in{
  animation:scaleIn 0.5s ease-out;
}

@keyframes scaleIn {
  from { opacity: 0; transform: scale(0.9); }
  to { opacity: 1; transform: scale(1); }
}

.ai-float{
  animation:aiFloat 4s ease-in-out infinite;
}

@keyframes aiFloat {
  0%, 100% { transform: translateY(0px) rotate(0deg); }
  50% { transform: translateY(-5px) rotate(1deg); }
}
</style>
</head>
<body>

<div class="container">
  <!-- Enhanced Header with AI Status -->
  <header class="slide-in">
    <div style="display:flex;gap:16px;align-items:center">
      <div class="logo"></div>
      <div>
        <h1>Phenomenal Financial Tracker</h1>
        <div class="sub">
          <span class="status-badge" id="systemStatus">
            <div class="status-dot"></div>
            <span id="statusText">System Ready</span>
          </span>
          <span>‚Ä¢ AI-Powered ‚Ä¢ Plaid Ready ‚Ä¢ LIVE Banking</span>
        </div>
      </div>
    </div>
    <div class="header-actions">
      <div class="connection-status">
        <div class="status-dot"></div>
        <span id="connectionCount">0 Banks Connected</span>
      </div>
      <button class="btn ai-btn" onclick="toggleAIAssistant()">
        üß† AI Assistant
      </button>
      <button class="btn plaid-btn" onclick="connectNewBank()">
        üîó Connect Bank
      </button>
      <button class="btn neural-btn" onclick="showExportModal()">
        üìä Export Data
      </button>
      <div class="user-info">
        <div class="user-avatar" id="userAvatar">U</div>
        <span id="userName">User</span>
      </div>
    </div>
  </header>

  <!-- AI-Enhanced Dashboard Grid -->
  <div class="grid4 fade-in" id="dashboardTiles">
    <!-- Demo tiles that work immediately -->
    <div class="tile ai-enhanced scale-in" onclick="openBalanceDetails()">
      <div class="tile-header">
        <div class="small">Total Balance</div>
        <div class="tile-icon">üíé</div>
      </div>
      <div class="val" id="totalBalance">$0.00</div>
      <div class="pill good" id="balanceChange">
        Ready to connect accounts
      </div>
    </div>
    
    <div class="tile ai-enhanced scale-in" style="animation-delay: 0.1s" onclick="openSpendingDetails()">
      <div class="tile-header">
        <div class="small">Monthly Spending</div>
        <div class="tile-icon">üìä</div>
      </div>
      <div class="val" id="monthlySpending">$0.00</div>
      <div class="pill ai-status" id="spendingStatus">
        Connect for insights
      </div>
    </div>
    
    <div class="tile ai-enhanced scale-in" style="animation-delay: 0.2s" onclick="openCashFlowDetails()">
      <div class="tile-header">
        <div class="small">AI Cash Flow</div>
        <div class="tile-icon">üéØ</div>
      </div>
      <div class="val" id="cashFlow">Ready</div>
      <div class="pill ai-status" id="cashFlowConfidence">
        AI Standing By
      </div>
    </div>
    
    <div class="tile ai-enhanced scale-in" style="animation-delay: 0.3s" onclick="openHealthScoreDetails()">
      <div class="tile-header">
        <div class="small">AI Health Score</div>
        <div class="tile-icon">üß†</div>
      </div>
      <div class="val" id="healthScore">Ready</div>
      <div class="pill good" id="healthStatus">
        System Active
      </div>
    </div>
  </div>

  <!-- AI Predictions & Insights -->
  <div class="card ai-powered slide-in" style="animation-delay: 0.5s">
    <h2>
      <div class="card-icon ai-icon">üîÆ</div>
      AI Financial Predictions
      <div style="margin-left:auto;font-size:14px;">
        <div class="pill ai-status">
          <div class="status-dot"></div>
          <span id="aiStatusText">Ready</span>
        </div>
      </div>
    </h2>

    <div class="insight-grid" id="aiInsights">
      <div class="insight-item" onclick="openTransactionAnalysis()">
        <div class="insight-value" id="transactionCount">0</div>
        <div class="insight-label">Transactions Ready</div>
      </div>
      <div class="insight-item" onclick="openSavingsOpportunities()">
        <div class="insight-value" id="savingsOpportunity">Ready</div>
        <div class="insight-label">Savings Analysis</div>
      </div>
      <div class="insight-item" onclick="openGroceryOptimization()">
        <div class="insight-value" id="bestGroceryDay">Smart</div>
        <div class="insight-label">Shopping Optimizer</div>
      </div>
      <div class="insight-item" onclick="openSubscriptionReview()">
        <div class="insight-value" id="unusedSubscriptions">AI</div>
        <div class="insight-label">Subscription Tracker</div>
      </div>
    </div>

    <div class="prediction-card" id="cashFlowPrediction">
      <h4 style="margin:0 0 12px 0;color:var(--ai)">üí° Cash Flow Prediction (Next 30 Days)</h4>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <span style="font-size:18px;font-weight:700" id="predictedCashFlow">Connect accounts for predictions</span>
        <span style="font-size:12px;color:var(--muted)">Confidence: <span id="predictionConfidence">Ready</span></span>
      </div>
      <div class="confidence-bar">
        <div class="confidence-fill" id="confidenceFill" style="width:0%"></div>
      </div>
      <div style="font-size:12px;color:var(--muted);line-height:1.4" id="predictionDetails">
        AI is ready to analyze your spending patterns and predict cash flow once you connect your accounts
      </div>
    </div>

    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-top:16px">
      <div class="prediction-card" style="padding:16px;cursor:pointer" onclick="openSmartBudget()">
        <h5 style="margin:0 0 8px 0;color:var(--neural)">üéØ Smart Budget</h5>
        <div style="font-size:20px;font-weight:700;color:var(--ai)" id="smartBudget">Ready</div>
        <div style="font-size:10px;color:var(--muted)">AI-optimized budgets</div>
      </div>
      
      <div class="prediction-card" style="padding:16px;cursor:pointer" onclick="openAlerts()">
        <h5 style="margin:0 0 8px 0;color:var(--neural)">üìÖ Smart Alerts</h5>
        <div style="font-size:20px;font-weight:700;color:var(--warn)" id="nextAlert">Ready</div>
        <div style="font-size:10px;color:var(--muted)">AI bill monitoring</div>
      </div>
      
      <div class="prediction-card" style="padding:16px;cursor:pointer" onclick="openSavingsGoal()">
        <h5 style="margin:0 0 8px 0;color:var(--neural)">üìà Savings Goals</h5>
        <div style="font-size:20px;font-weight:700;color:var(--good)" id="savingsProjection">Ready</div>
        <div style="font-size:10px;color:var(--muted)">Goal tracking</div>
      </div>
    </div>
  </div>

  <!-- Neural Network Visualization -->
  <div class="card ai-powered slide-in" style="animation-delay: 0.6s">
    <h3>
      <div class="card-icon ai-icon">üß¨</div>
      AI Learning Network
      <div style="margin-left:auto;">
        <div class="pill neural-status">
          System Active
        </div>
      </div>
    </h3>
    
    <div class="neural-viz" id="neuralNetwork">
      <!-- Neural network visualization will be generated here -->
    </div>
    
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-top:16px">
      <div style="text-align:center">
        <div style="font-size:18px;font-weight:800;color:var(--neural)" id="patternsLearned">Ready</div>
        <div style="font-size:10px;color:var(--muted)">Patterns Ready</div>
      </div>
      <div style="text-align:center">
        <div style="font-size:18px;font-weight:800;color:var(--ai)" id="accuracyScore">100%</div>
        <div style="font-size:10px;color:var(--muted)">System Accuracy</div>
      </div>
      <div style="text-align:center">
        <div style="font-size:18px;font-weight:800;color:var(--good)" id="modelsActive">15</div>
        <div style="font-size:10px;color:var(--muted)">AI Models Ready</div>
      </div>
      <div style="text-align:center">
        <div style="font-size:18px;font-weight:800;color:var(--warn)" id="dataPoints">Ready</div>
        <div style="font-size:10px;color:var(--muted)">Data Processing</div>
      </div>
    </div>
  </div>

  <!-- Smart Account Management -->
  <div class="card slide-in" style="animation-delay: 0.7s">
    <h2>
      <div class="card-icon">üè¶</div>
      Smart Account Management
      <div style="margin-left:auto;font-size:14px;" id="syncStatus">
        <div class="pill plaid-status">
          <div class="status-dot"></div>
          <span id="syncStatusText">Ready to Connect</span>
        </div>
      </div>
    </h2>

    <div class="account-grid" id="accountGrid">
      <div style="text-align:center;padding:40px;color:var(--muted)">
        <div style="font-size:48px;margin-bottom:16px">üè¶</div>
        <div style="margin-bottom:16px">Ready to connect your first bank account</div>
        <button class="btn plaid-btn" onclick="connectNewBank()">
          üöÄ Connect Your First Bank
        </button>
        <div style="font-size:12px;margin-top:12px;color:var(--muted)">
          üîí Bank-level security via Plaid ‚Ä¢ Real-time updates ‚Ä¢ AI insights
        </div>
      </div>
    </div>
  </div>

  <!-- Cash Flow to Next Payday Tracker -->
  <div class="card slide-in" style="animation-delay: 0.85s">
    <h3>
      <div class="card-icon">üí∞</div>
      Cash Flow to Next Payday
      <div style="margin-left:auto;font-size:12px;">
        <div class="pill ai-status" id="paydayCountdown">
          üìÖ Ready
        </div>
      </div>
    </h3>

    <div style="margin:20px 0" id="cashFlowTracker">
      <div style="text-align:center;padding:40px;color:var(--muted)">
        <div style="font-size:48px;margin-bottom:16px">üí∞</div>
        <div>Connect accounts to track cash flow to payday</div>
        <div style="font-size:12px;margin-top:8px">AI will learn your payroll patterns and predict your cash flow</div>
      </div>
    </div>
  </div>

  <!-- Smart Recurring Bills Section -->
  <div class="card slide-in" style="animation-delay: 0.9s">
    <h3>
      <div class="card-icon">üìÖ</div>
      Smart Recurring Bills & Subscriptions
      <div style="margin-left:auto;font-size:12px;">
        <div class="pill ai-status" id="billsStatus">
          AI Ready
        </div>
      </div>
    </h3>

    <div id="billsContent">
      <div style="text-align:center;padding:40px;color:var(--muted)">
        <div style="font-size:48px;margin-bottom:16px">üìÖ</div>
        <div>Connect accounts to discover recurring bills and subscriptions</div>
        <div style="font-size:12px;margin-top:8px">AI will automatically identify and track your recurring charges</div>
      </div>
    </div>
  </div>

  <!-- Category Spending Analysis -->
  <div class="card slide-in" style="animation-delay: 0.95s">
    <h3>
      <div class="card-icon">üìä</div>
      Category Spending Analysis
      <div style="margin-left:auto;font-size:12px;">
        <div class="pill ai-status">
          Ready
        </div>
      </div>
    </h3>

    <div id="categoryAnalysis">
      <div style="text-align:center;padding:40px;color:var(--muted)">
        <div style="font-size:48px;margin-bottom:16px">üìä</div>
        <div>Connect accounts for automatic spending categorization</div>
        <div style="font-size:12px;margin-top:8px">AI will categorize your transactions and analyze spending patterns</div>
      </div>
    </div>
  </div>

  <!-- Intelligent Transaction Stream -->
  <div class="card slide-in" style="animation-delay: 1.0s">
    <h3>
      <div class="card-icon">‚ö°</div>
      Intelligent Transaction Stream
      <div style="margin-left:auto;font-size:12px;">
        <div class="pill ai-status" id="webhookStatus">
          AI-Powered
        </div>
      </div>
    </h3>

    <div class="transaction-stream" id="transactionStream">
      <div style="text-align:center;padding:40px;color:var(--muted)">
        <div style="font-size:48px;margin-bottom:16px">‚ö°</div>
        <div>Connect accounts to see real-time transactions</div>
        <div style="font-size:12px;margin-top:8px">Live transaction feed with AI categorization and insights</div>
      </div>
    </div>
  </div>

  <!-- Advanced AI Analytics -->
  <div class="card ai-powered slide-in" style="animation-delay: 1.05s">
    <h3>
      <div class="card-icon ai-icon">üìä</div>
      Advanced AI Analytics
      <div style="margin-left:auto">
        <div class="pill neural-status">
          Ready for Data
        </div>
      </div>
    </h3>

    <div id="advancedAnalytics">
      <div style="text-align:center;padding:40px;color:var(--muted)">
        <div style="font-size:48px;margin-bottom:16px">üß†</div>
        <div>AI analytics engine ready for your financial data</div>
        <div style="font-size:12px;margin-top:8px">Advanced insights, predictions, and optimization recommendations</div>
      </div>
    </div>
  </div>

</div>

<!-- Enhanced Plaid Connection Modal -->
<div class="plaid-modal" id="plaidModal">
  <div class="plaid-dialog">
    <h3 id="modalTitle">üîó Connect Your Bank Account</h3>
    <div id="modalContent">
      <div style="margin:20px 0">
        <div style="font-size:48px;margin-bottom:16px">üè¶</div>
        <div style="font-size:16px;margin-bottom:16px;color:var(--muted)">
          Connect your real bank account using Plaid
        </div>
        <div style="font-size:12px;color:var(--muted);line-height:1.6">
          üîí Bank-level security ‚Ä¢ üöÄ Instant connection ‚Ä¢ ‚ö° Real-time updates<br>
          <span style="color:var(--warn)">‚ö†Ô∏è Requires backend server for token generation</span>
        </div>
      </div>
      
      <div id="progressSection" style="display:none;margin:20px 0">
        <div style="margin-bottom:12px;font-weight:600;color:var(--plaid)" id="progressText">Connecting...</div>
        <div class="progress-container">
          <div class="progress-fill" id="progressFill" style="width:0%"></div>
        </div>
        <div style="font-size:12px;color:var(--muted);margin-top:8px">
          This may take a few moments while we securely authenticate your account
        </div>
      </div>
      
      <div style="display:flex;gap:12px;justify-content:center;margin-top:24px" id="buttonSection">
        <button class="btn plaid-btn" onclick="initializePlaidLink()" id="connectBtn">
          üöÄ Connect My Bank
        </button>
        <button class="btn" onclick="closePlaidModal()">
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Export Data Modal -->
<div class="plaid-modal" id="exportModal">
  <div class="plaid-dialog" style="max-width:600px">
    <h3 id="exportModalTitle">üìä Export Financial Data</h3>
    <div id="exportModalContent">
      <div style="margin:20px 0">
        <div style="text-align:center;margin-bottom:20px">
          <div style="font-size:48px;margin-bottom:12px">üìà</div>
          <div style="font-size:16px;margin-bottom:8px;color:var(--muted)">
            Export your financial data for analysis, taxes, or external tools
          </div>
          <div style="font-size:12px;color:var(--muted);line-height:1.6">
            üß† AI-enhanced exports include insights and predictions
          </div>
        </div>
        
        <!-- Export Options -->
        <div style="display:grid;gap:12px;margin:20px 0">
          <div class="export-option" onclick="exportData('transactions-csv')" style="padding:16px;background:rgba(23,201,100,0.1);border:1px solid rgba(23,201,100,0.3);border-radius:12px;cursor:pointer;transition:all 0.3s ease">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div style="font-weight:700;color:var(--good)">üìä Transactions CSV</div>
                <div style="font-size:12px;color:var(--muted)">All transactions with AI categorization</div>
              </div>
              <div style="font-size:20px">üíæ</div>
            </div>
          </div>
          
          <div class="export-option" onclick="exportData('budget-excel')" style="padding:16px;background:rgba(78,205,196,0.1);border:1px solid rgba(78,205,196,0.3);border-radius:12px;cursor:pointer;transition:all 0.3s ease">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div style="font-weight:700;color:var(--neural)">üìà Budget Analysis Excel</div>
                <div style="font-size:12px;color:var(--muted)">Spending by category with AI insights</div>
              </div>
              <div style="font-size:20px">üìã</div>
            </div>
          </div>
          
          <div class="export-option" onclick="exportData('cashflow-excel')" style="padding:16px;background:rgba(0,212,255,0.1);border:1px solid rgba(0,212,255,0.3);border-radius:12px;cursor:pointer;transition:all 0.3s ease">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div style="font-weight:700;color:var(--plaid)">üí∞ Cash Flow Tracker Excel</div>
                <div style="font-size:12px;color:var(--muted)">Your payday-to-payday tracking like Google Sheets</div>
              </div>
              <div style="font-size:20px">üìä</div>
            </div>
          </div>
          
          <div class="export-option" onclick="exportData('ai-report-pdf')" style="padding:16px;background:rgba(255,107,157,0.1);border:1px solid rgba(255,107,157,0.3);border-radius:12px;cursor:pointer;transition:all 0.3s ease">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div style="font-weight:700;color:var(--ai)">üß† AI Financial Report PDF</div>
                <div style="font-size:12px;color:var(--muted)">Complete analysis with predictions and insights</div>
              </div>
              <div style="font-size:20px">üìÑ</div>
            </div>
          </div>
          
          <div class="export-option" onclick="exportData('tax-summary')" style="padding:16px;background:rgba(124,92,255,0.1);border:1px solid rgba(124,92,255,0.3);border-radius:12px;cursor:pointer;transition:all 0.3s ease">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div style="font-weight:700;color:var(--accent)">üìã Tax Summary CSV</div>
                <div style="font-size:12px;color:var(--muted)">Income and deductible expenses for tax prep</div>
              </div>
              <div style="font-size:20px">üóÇÔ∏è</div>
            </div>
          </div>
        </div>
        
        <!-- Export Settings -->
        <div style="margin:20px 0;padding:16px;background:rgba(255,255,255,0.05);border-radius:12px">
          <h4 style="margin:0 0 12px 0;color:var(--ai)">üìÖ Date Range</h4>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div>
              <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:4px">From Date</label>
              <input type="date" id="exportFromDate" value="2025-02-01" style="width:100%">
            </div>
            <div>
              <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:4px">To Date</label>
              <input type="date" id="exportToDate" value="2025-08-17" style="width:100%">
            </div>
          </div>
          
          <div style="margin-top:12px">
            <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:4px">
              <input type="checkbox" id="includeAIInsights" checked style="margin-right:8px">
              Include AI insights and predictions
            </label>
            <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:4px">
              <input type="checkbox" id="includeConfidenceScores" checked style="margin-right:8px">
              Include AI confidence scores
            </label>
          </div>
        </div>
      </div>
      
      <div style="display:flex;gap:12px;justify-content:center;margin-top:24px">
        <button class="btn" onclick="closeExportModal()">
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>

<!-- AI Assistant Chat Interface -->
<div class="ai-assistant" id="aiAssistant">
  <div class="ai-header">
    <div style="display:flex;align-items:center;gap:12px">
      <div class="ai-avatar">üß†</div>
      <div>
        <div style="font-weight:700;color:var(--ai)">Financial AI</div>
        <div style="font-size:10px;color:var(--muted)">Your Personal Finance Assistant</div>
      </div>
    </div>
    <button onclick="toggleAIAssistant()" style="background:none;border:none;color:var(--text);cursor:pointer">‚úï</button>
  </div>
  
  <div class="ai-chat" id="aiChat">
    <div class="ai-message">
      <strong style="color:var(--ai)">üß† AI Assistant:</strong><br>
      Hi! I'm your AI financial assistant. Once you connect your bank accounts, I'll provide personalized insights about your spending, savings opportunities, and financial health. What would you like to know?
    </div>
  </div>
  
  <div class="ai-input">
    <input type="text" placeholder="Ask me anything about your finances..." id="aiChatInput" onkeypress="handleAIChatKeypress(event)">
    <button onclick="sendAIMessage()">üöÄ</button>
  </div>
</div>

<!-- Enhanced Notification System -->
<div class="notification" id="notification">
  <!-- Notifications will be populated by JavaScript -->
</div>

<!-- Interactive Details Modal -->
<div class="plaid-modal" id="detailsModal">
  <div class="plaid-dialog" style="max-width:700px">
    <h3 id="modalDetailTitle">Details</h3>
    <div id="modalDetailContent">
      <!-- Detail content will be populated by JavaScript -->
    </div>
    <div style="display:flex;gap:12px;justify-content:center;margin-top:24px">
      <button class="btn ai-btn" onclick="closeDetailsModal()">
        Close
      </button>
    </div>
  </div>
</div>

<script>
/* =========================================================================
   Phenomenal Financial Tracker ‚Äî PROPER PLAID WIRING (drop-in)
   - Expects backend routes:
       POST /api/create_link_token
       POST /api/set_access_token
       POST /api/transactions
     and a health check at: GET /health
   ======================================================================= */

console.log('üß† Phenomenal Financial Tracker ‚Äî Plaid wiring active');

const API_BASE = window.location.origin;   // same Render service
const USER_ID  = 'user_001';               // replace with your auth user id if you have one

// --- App state (kept small; we derive accounts from transactions) ---
const AppState = {
  user: { id: USER_ID, name: 'User' },
  accounts: new Map(),          // Map<account_id, {account_id,name,mask,balances:{current}} >
  transactions: [],             // Plaid transactions
  totals: { connectedBanks: 0, monthlySpending: 0, netWorth: 0, totalTransactions: 0 },
  plaidLinkToken: null,
  backendStatus: 'unknown',
  isConnecting: false
};

// ===== Boot =====
document.addEventListener('DOMContentLoaded', () => {
  initializeUI();
  document.getElementById('userName').textContent = AppState.user.name;
  document.getElementById('userAvatar').textContent = AppState.user.name[0].toUpperCase();
  tryLoadLiveData(); // graceful if backend is down
  showNotification('üöÄ Phenomenal Tracker ready! Connect your first bank to get started.', 'success');
});

// ===== Health + initial data =====
async function tryLoadLiveData() {
  try {
    const res = await fetch(`${API_BASE}/health`);
    if (!res.ok) throw new Error('health not ok');
    AppState.backendStatus = 'available';
    await tryLoadTransactions();     // we rely on transactions endpoint only
    updateDashboard();
    showNotification('‚úÖ Connected to live backend!', 'success');
  } catch {
    AppState.backendStatus = 'unavailable';
    updateDashboard();               // stays in ‚ÄúReady to connect‚Äù state
    showNotification('‚ÑπÔ∏è Backend not reachable yet. You can still open Link once it is.', 'info');
  }
}

// ===== Plaid Link flow =====
async function connectNewBank() {
  if (AppState.isConnecting) return;
  AppState.isConnecting = true;
  showPlaidModal();

  try {
    const r = await fetch(`${API_BASE}/api/create_link_token`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: USER_ID })
    });
    if (!r.ok) throw new Error(`create_link_token ${r.status}`);
    const { link_token } = await r.json();
    AppState.plaidLinkToken = link_token;

    const handler = Plaid.create({
      token: link_token,
      onSuccess: handlePlaidSuccess,
      onExit: (err) => {
        if (err) showNotification('‚ùå Bank connection cancelled', 'error');
        closePlaidModal();
        AppState.isConnecting = false;
      }
    });

    handler.open();
  } catch (e) {
    console.error(e);
    showNotification('‚ö†Ô∏è Could not create Plaid Link token (check backend routes).', 'warning');
    closePlaidModal();
    AppState.isConnecting = false;
  }
}

async function handlePlaidSuccess(public_token, metadata) {
  try {
    console.log('‚úÖ Link success', metadata);

    // 1) Exchange & save the access_token for THIS user
    const ex = await fetch(`${API_BASE}/api/exchange_public_token`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        public_token,
        user_id: AppState.user.id, // use the same user id everywhere
      }),
    });

    const exJson = await ex.json().catch(() => ({}));
    if (!ex.ok || !exJson?.success) {
      console.error('Exchange failed:', ex.status, exJson);
      showNotification?.('Token exchange failed. Check server logs.', 'error');
      return;
    }

    // 2) Fetch accounts and update the ‚ÄúBanks Connected‚Äù pill
    const accRes = await fetch(`${API_BASE}/api/accounts`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: AppState.user.id }),
    });

    if (!accRes.ok) {
      const txt = await accRes.text();
      console.error('Accounts error:', txt);
      showNotification?.('Could not load accounts.', 'warning');
      return;
    }

    const accData = await accRes.json();
    const accounts = accData.accounts || [];
    AppState.accounts = new Map(accounts.map(a => [a.account_id, a]));

    // Update header pill (try a few possible element ids)
    const n = accounts.length;
    ['connectionCount', 'connectedCount', 'banksConnectedCount'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.textContent = `${n} ${n === 1 ? 'Bank' : 'Banks'} Connected`;
    });

    // 3) Kick off transactions fetch (okay if still syncing)
    const txRes = await fetch(`${API_BASE}/api/transactions`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        user_id: AppState.user.id,
        start_date: '2024-01-01',
      }),
    });

    if (txRes.status === 202) {
      console.log('Transactions are syncing; try again shortly.');
    } else if (txRes.ok) {
      const txJson = await txRes.json();
      AppState.transactions = txJson.transactions || [];
      // Update any transactions counter if present
      ['transactionsReady', 'transactionsCount'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = String(AppState.transactions.length);
      });
      if (typeof updateDashboard === 'function') updateDashboard();

} else {
  const txt = await txRes.text();
  console.warn('Transactions fetch failed:', txt);
}
    } else {
      const txt = await txRes.text();
      console.warn('Transactions fetch failed:', txt);
    }

    // Close modal/UI niceties if you have them
    closePlaidModal?.();
    AppState.isConnecting = false;
    showNotification?.(`${metadata?.institution?.name || 'Bank'} connected!`, 'success');
  } catch (err) {
    console.error('handlePlaidSuccess failed:', err);
    AppState.isConnecting = false;
    showNotification?.('Something went wrong after linking. See console.', 'error');
  }
}


// ===== Data fetching =====
async function tryLoadTransactions() {
  try {
    const r = await fetch(`${API_BASE}/api/transactions`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: USER_ID })
    });
    if (!r.ok) throw new Error(`transactions ${r.status}`);
    const data = await r.json();

    AppState.transactions = Array.isArray(data.transactions) ? data.transactions : [];
    AppState.totals.totalTransactions = AppState.transactions.length;

    // Derive a minimal ‚Äúaccounts‚Äù set from transaction account_ids
    const ids = [...new Set(AppState.transactions.map(t => t.account_id).filter(Boolean))];
    AppState.accounts = new Map(ids.map(id => [id, {
      account_id: id,
      name: 'Linked Account',
      mask: id.slice(-4),
      balances: { current: 0 }   // unknown without a balances endpoint
    }]));
    AppState.totals.connectedBanks = AppState.accounts.size;

    updateAccountsDisplay();     // renders cards even without balances endpoint
    updateTransactionsDisplay();
  } catch (e) {
    console.log('No transactions yet (connect a bank to load).');
  }
}

// ===== UI helpers (reusing your existing markup) =====
function updateDashboard() {
  // total balance (unknown without balances endpoint) -> keep at $0.00 unless you add one
  document.getElementById('totalBalance').textContent = formatCurrency(AppState.totals.netWorth || 0);

  // monthly spending if we have txns
  if (AppState.transactions.length) {
    const now = new Date();
    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
    const monthly = AppState.transactions
      .filter(tx => new Date(tx.date) >= startOfMonth && tx.amount < 0)
      .reduce((s, tx) => s + Math.abs(tx.amount), 0);
    AppState.totals.monthlySpending = monthly;
    document.getElementById('monthlySpending').textContent = formatCurrency(monthly);
    document.getElementById('spendingStatus').textContent = 'Real data analysis';
    document.getElementById('spendingStatus').className = 'pill good';
  } else {
    document.getElementById('monthlySpending').textContent = '$0.00';
    document.getElementById('spendingStatus').textContent = 'Connect for insights';
    document.getElementById('spendingStatus').className = 'pill ai-status';
  }

  // banks connected
  const n = AppState.totals.connectedBanks || 0;
  document.getElementById('connectionCount').textContent = `${n} Bank${n===1?'':'s'} Connected`;
  document.getElementById('syncStatusText').textContent = n ? 'Live Sync Active' : 'Ready to Connect';
  document.getElementById('statusText').textContent = n ? 'AI System Active' : 'Ready to Connect';

  // counter tile
  document.getElementById('transactionCount').textContent = String(AppState.totals.totalTransactions || 0);
}

function updateAccountsDisplay() {
  const grid = document.getElementById('accountGrid');
  if (!AppState.accounts.size) {
    grid.innerHTML = `
      <div style="text-align:center;padding:40px;color:var(--muted)">
        <div style="font-size:48px;margin-bottom:16px">üè¶</div>
        <div style="margin-bottom:16px">Ready to connect your first bank account</div>
        <button class="btn plaid-btn" onclick="connectNewBank()">üöÄ Connect Your First Bank</button>
        <div style="font-size:12px;margin-top:12px;color:var(--muted)">
          üîí Bank-level security via Plaid ‚Ä¢ Real-time updates ‚Ä¢ AI insights
        </div>
      </div>`;
    return;
  }

  const cards = [...AppState.accounts.values()].map(a => `
    <div class="account-card chase">
      <div class="account-header">
        <div style="display:flex;align-items:center;gap:12px">
          <div class="bank-logo chase">Bank</div>
          <div>
            <div style="font-weight:700">${a.name}</div>
            <div style="font-size:12px;color:var(--muted)">Account ‚Ä¢‚Ä¢‚Ä¢‚Ä¢${a.mask || '----'}</div>
          </div>
        </div>
        <div class="pill plaid-status">Live Connected</div>
      </div>
      <div class="account-balance">‚Äî</div>
      <div class="account-meta">
        <span>Live sync ‚Ä¢ Real-time updates</span>
        <span class="sync-indicator"><div class="status-dot"></div>Live</span>
      </div>
    </div>`).join('');

  grid.innerHTML = cards;
}

function updateTransactionsDisplay() {
  const container = document.getElementById('transactionStream');
  if (!AppState.transactions.length) {
    container.innerHTML = `
      <div style="text-align:center;padding:40px;color:var(--muted)">
        <div style="font-size:48px;margin-bottom:16px">‚ö°</div>
        <div>Connect accounts to see real-time transactions</div>
        <div style="font-size:12px;margin-top:8px">Live transaction feed with AI categorization and insights</div>
      </div>`;
    return;
  }

  const recent = AppState.transactions
    .slice() // copy
    .sort((a,b) => new Date(b.date) - new Date(a.date))
    .slice(0, 10);

  container.innerHTML = recent.map(tx => {
    const category = (tx.category && tx.category[0]) || 'Other';
    const amount = formatCurrency(Math.abs(tx.amount));
    const sign = tx.amount > 0 ? '+' : '-';
    const cls  = tx.amount > 0 ? 'positive' : 'negative';
    return `
      <div class="transaction-item">
        <div class="merchant-info">
          <div class="merchant-icon">üí≥</div>
          <div>
            <div style="font-weight:700">${tx.name}</div>
            <div style="font-size:12px;color:var(--muted)">${new Date(tx.date).toLocaleDateString()} ‚Ä¢ ${category}</div>
          </div>
        </div>
        <div class="transaction-amount ${cls}">${sign}${amount}</div>
      </div>`;
  }).join('');
}

// ===== Plaid modal controls (reuse your markup) =====
function showPlaidModal(){ document.getElementById('plaidModal').classList.add('show'); }
function closePlaidModal(){ document.getElementById('plaidModal').classList.remove('show'); }

// ===== Utilities & existing helpers you already use =====
function initializeUI(){ /* placeholder hook */ }
function showNotification(message, type='info', duration=4000){
  const el = document.getElementById('notification');
  const icons = { success:'‚úÖ', error:'‚ùå', info:'‚ÑπÔ∏è', warning:'‚ö†Ô∏è', ai:'üß†' };
  el.className = `notification ${type}`;
  el.innerHTML = `<div style="display:flex;align-items:center;gap:12px">
      <div style="font-size:20px">${icons[type]||'‚ÑπÔ∏è'}</div>
      <div><div style="font-weight:700">${message}</div>
      <div style="font-size:12px;color:var(--muted)">${new Date().toLocaleTimeString()}</div></div></div>`;
  el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), duration);
}
function formatCurrency(x){ return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(x||0); }

// Expose a tiny console API for quick checks
window.PhenomenalAI = {
  connectBank: connectNewBank,
  refreshData: tryLoadLiveData,
  getSystemInfo: () => ({ backend: API_BASE, backendStatus: AppState.backendStatus, banks: AppState.totals.connectedBanks, txns: AppState.totals.totalTransactions })
};

console.log('‚úÖ Plaid wiring ready. Health check =>', `${API_BASE}/health`);
// ===== BEGIN: override handlePlaidSuccess + live dashboard updates =====
(function () {
  // API base
  const API_BASE = location.origin;

  // --- helpers ---
  function fmtUSD(n) {
    return (Number(n) || 0).toLocaleString('en-US', { style: 'currency', currency: 'USD' });
  }

  function notify(kind, msg) {
    if (typeof window.showNotification2 === 'function') return window.showNotification2(kind, msg);
    if (typeof window.showNotification === 'function') return window.showNotification(kind, msg);
    console[kind === 'error' ? 'error' : (kind === 'warning' ? 'warn' : 'log')](msg);
  }

  function closeLinkModalIfAny() {
    if (typeof window.closePlaidModal2 === 'function') return window.closePlaidModal2();
    if (typeof window.closePlaidModal === 'function') return window.closePlaidModal();
  }

  // Find the value element for the tiles by label text
  function findMetricValueEl(labelText) {
    const all = Array.from(document.querySelectorAll('*'));
    const labelNode = all.find(el => {
      try { return (el.textContent || '').trim().toLowerCase() === labelText.toLowerCase(); }
      catch { return false; }
    });
    if (!labelNode) return null;

    // bubble up a few levels to the card
    let card = labelNode;
    for (let i = 0; i < 4 && card; i++) card = card.parentElement;
    if (!card) card = labelNode.closest('div');

    const candidates = Array.from(card.querySelectorAll('span, div, p, h1, h2, h3'))
      .filter(el => {
        const txt = (el.textContent || '').trim();
        return /\$|^\d+(\.\d+)?$/.test(txt) && txt.length <= 20;
      });
    if (candidates.length) return candidates[0];

    return card.querySelector('span, div, p, h1, h2, h3') || null;
  }

  function ensureMetricTargets() {
    let totalEl = document.getElementById('totalBalanceValue');
    let monthEl = document.getElementById('monthlySpendingValue');

    if (!totalEl) {
      const found = findMetricValueEl('Total Balance');
      if (found) { found.id = 'totalBalanceValue'; totalEl = found; }
    }
    if (!monthEl) {
      const found = findMetricValueEl('Monthly Spending');
      if (found) { found.id = 'monthlySpendingValue'; monthEl = found; }
    }
    return { totalEl, monthEl };
  }

  function updateBanksPill(n) {
    ['connectionCount', 'connectedCount', 'banksConnectedCount'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.textContent = `${n} ${n === 1 ? 'Bank' : 'Banks'} Connected`;
    });
  }

  // Update dashboard using AppState.{accounts,transactions}
  function updateDashboard() {
    if (typeof window.AppState !== 'object') return;

    const accountsArr = window.AppState.accounts instanceof Map
      ? Array.from(window.AppState.accounts.values())
      : (window.AppState.accounts || []);

    const total = accountsArr.reduce((sum, a) => {
      const b = a && a.balances ? a.balances : {};
      const v = (b.current ?? b.available ?? 0);
      return sum + (Number(v) || 0);
    }, 0);

    const now = new Date();
    const ym = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2,'0')}`;
    const txs = Array.isArray(window.AppState.transactions) ? window.AppState.transactions : [];
    const monthlySpending = txs.reduce((sum, t) => {
      const d = (t.date || t.authorized_date || '').slice(0, 7);
      const amt = Number(t.amount) || 0;
      if (d === ym && amt > 0) return sum + amt; // positive = outflow
      return sum;
    }, 0);

    const { totalEl, monthEl } = ensureMetricTargets();
    if (totalEl) totalEl.textContent = fmtUSD(total);
    if (monthEl) monthEl.textContent = fmtUSD(monthlySpending);

    updateBanksPill(accountsArr.length);
  }

  // >>> OVERRIDE the existing handler used by Plaid Link <<<
  window.handlePlaidSuccess = async function (public_token, metadata) {
    try {
      console.log('üîó Link success', metadata);
      const user_id = window.AppState?.user_id || 'user-1';

      // 1) exchange token
      const ex = await fetch(`${API_BASE}/api/exchange_public_token`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ public_token, user_id }),
      });
      const exJson = await ex.json().catch(() => ({}));
      if (!ex.ok || !exJson?.success) {
        console.error('Exchange failed:', ex.status, exJson);
        notify('error', 'Token exchange failed. Check server logs.');
        return;
      }

      // 2) accounts
      const accRes = await fetch(`${API_BASE}/api/accounts`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id }),
      });
      if (!accRes.ok) {
        const txt = await accRes.text();
        console.error('Accounts error:', txt);
        notify('warning', 'Could not load accounts.');
        return;
      }
      const accData = await accRes.json();
      const accList = accData?.accounts || [];
      window.AppState = window.AppState || {};
      window.AppState.accounts = new Map(accList.map(a => [a.account_id, a]));
      updateBanksPill(accList.length);

      // 3) transactions
      const txRes = await fetch(`${API_BASE}/api/transactions`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id, start_date: '2024-01-01' }),
      });

      if (txRes.status === 202) {
        console.log('Transactions are syncing; try again shortly.');
      } else if (txRes.ok) {
        const tJson = await txRes.json();
        window.AppState.transactions = tJson?.transactions || [];
      } else {
        const txt = await txRes.text();
        console.warn('Transactions fetch failed:', txt);
      }

      // update UI
      updateDashboard();

      // close + notify
      closeLinkModalIfAny();
      notify('success', `${metadata?.institution?.name || 'Bank'} connected`);
    } catch (err) {
      console.error('handlePlaidSuccess failed:', err);
      notify('error', 'Something went wrong after linking. See console.');
    } finally {
      if (window.AppState) window.AppState.isConnecting = false;
    }
  };

  // Expose for manual refresh if you want
  window.updateDashboard = updateDashboard;
})();
/// ===== END override =====
  
</script>


</body>
</html>
